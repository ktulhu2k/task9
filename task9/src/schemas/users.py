"""
Схемы валидации данных для системы аутентификации и управления пользователями.

Содержит Pydantic-модели, используемые для:
- регистрации новых пользователей;
- аутентификации по логину и паролю;
- генерации и проверки JWT-токенов.

Все схемы совместимы с FastAPI и обеспечивают автоматическую валидацию
входных данных в Swagger UI и при API-запросах.
"""

import re
from typing import Optional
from pydantic import BaseModel, EmailStr, field_validator


class UserCreate(BaseModel):
    """
    Схема создания пользователя (используется для внутренней логики).
    
    Поля идентичны UserRegister, но может отличаться валидацией в будущем.
    """

    username: str
    """Уникальное имя пользователя (логин)."""

    email: EmailStr
    """Электронная почта в валидном формате."""

    password: str
    """Пароль (в открытом виде, до хэширования)."""


class UserRegister(BaseModel):
    """
    Схема регистрации нового пользователя через API.
    
    Используется в эндпоинте POST /api_v1/register.
    """

    username: str
    """Уникальное имя пользователя. Должно соответствовать требованиям безопасности."""

    email: EmailStr
    """Электронная почта. Должна быть в корректном формате."""

    password: str
    """Пароль"""

    @field_validator("username")
    @classmethod
    def validate_username(cls, v: str) -> str:
        """
        Валидация имени пользователя:
        - длина от 3 до 20 символов;
        - только буквы, цифры, подчёркивания и дефисы.
        """
        if not (3 <= len(v) <= 20):
            raise ValueError("Имя пользователя должно содержать от 3 до 20 символов")
        if not re.match(r"^[a-zA-Z0-9_-]+$", v):
            raise ValueError("Имя пользователя может содержать только буквы, цифры, '_', '-'")
        return v


class UserLogin(BaseModel):
    """
    Схема входа в систему.
    
    Используется в эндпоинте POST /api_v1/login (form-data).
    """

    username: str
    """Имя пользователя."""

    password: str
    """Пароль в открытом виде."""


class Token(BaseModel):
    """
    Схема JWT-токена доступа.
    
    Возвращается при успешной аутентификации или регистрации.
    """

    access_token: str
    """JWT-токен в формате строки."""

    token_type: str = "bearer"
    """Тип токена (стандарт OAuth2 — 'bearer')."""


class TokenData(BaseModel):
    """
    Схема данных, закодированных в JWT-токене.
    
    Используется для извлечения информации из токена при валидации.
    """

    username: Optional[str] = None
    """Имя пользователя, закодированное в токене."""